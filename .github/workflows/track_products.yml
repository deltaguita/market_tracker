name: Track Products

on:
  schedule:
    # 每 2 小時執行一次，台灣時間 08:00-24:00（UTC 00:00-16:00）
    - cron: "0 0,2,4,6,8,10,12,14,16 * * *"
  workflow_dispatch: # 允許手動觸發，可在任何分支執行

jobs:
  # 準備階段：讀取 URLs 並生成 matrix
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate matrix from URLs
        id: set-matrix
        run: |
          python3 << 'EOF'
          import json
          import os

          with open('config/urls.json', 'r', encoding='utf-8') as f:
              config = json.load(f)

          urls = config.get('tracking_urls', [])
          if not urls:
              print("No URLs found")
              exit(1)

          # 生成 matrix，每個 URL 一個 job
          matrix_items = []
          for i, url in enumerate(urls):
              matrix_items.append({
                  "url_index": i,
                  "url_name": url.get("name", f"URL-{i}")
              })

          matrix = {"include": matrix_items}

          # 輸出到 GITHUB_OUTPUT
          output_file = os.environ.get('GITHUB_OUTPUT', '/dev/stdout')
          with open(output_file, 'a') as f:
              f.write(f"matrix<<MATRIX_EOF\n")
              f.write(json.dumps(matrix))
              f.write(f"\nMATRIX_EOF\n")
          EOF

  # 執行測試
  test:
    runs-on: ubuntu-latest
    needs: [prepare]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          python -m unittest discover tests -v

      - name: Notify on test failure
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          MESSAGE="❌ <b>測試失敗</b>%0A%0ARepository: ${{ github.repository }}%0AWorkflow: ${{ github.workflow }}%0ARun ID: ${{ github.run_id }}%0ACommit: ${{ github.sha }}%0A%0A<a href=\"${WORKFLOW_URL}\">查看詳細資訊</a>"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=HTML" \
            -d "disable_web_page_preview=false" || echo "Failed to send notification"

  # 更新匯率（只執行一次）
  update-exchange-rate:
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Update exchange rate
        run: python update_exchange_rate.py

      - name: Upload exchange rate database as artifact
        uses: actions/upload-artifact@v4
        with:
          name: exchange-rate-db
          path: data/exchange_rate.db
          retention-days: 1

  # 統一 commit 和 push 所有變更
  finalize:
    needs: [track, update-exchange-rate]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: products-db-*
          merge-multiple: false
          path: artifacts/

      - name: Download exchange rate database
        uses: actions/download-artifact@v4
        with:
          pattern: exchange-rate-db
          merge-multiple: false
          path: artifacts/

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Merge product databases
        run: |
          python merge_databases.py

      - name: Copy exchange rate database
        run: |
          if [ -f "artifacts/exchange-rate-db/exchange_rate.db" ]; then
            mkdir -p data
            cp artifacts/exchange-rate-db/exchange_rate.db data/exchange_rate.db
            echo "✓ 已複製匯率資料庫"
          else
            echo "警告: 未找到匯率資料庫，使用現有的"
          fi

      - name: Commit and push all changes
        run: |
          git config --local user.email "deltaguita@gmail.com"
          git config --local user.name "deltaguita"
          # 先 fetch 遠端變更
          git fetch origin
          # 暫存變更
          git add data/products.db data/exchange_rate.db
          # 如果有變更，先 commit
          if ! git diff --staged --quiet; then
            git commit -m "Update product data and exchange rate [skip ci]"
          fi
          # 拉取遠端變更並 rebase（如果有新的 commit）
          if [ -n "$(git log HEAD..origin/main)" ]; then
            git pull --rebase origin main || {
              echo "Rebase failed, resetting and using merge strategy"
              git rebase --abort 2>/dev/null || true
              # 如果 rebase 失敗，使用 merge（保留我們的變更）
              git merge origin/main -X ours -m "Merge remote changes [skip ci]" || {
                echo "Merge also failed, forcing push (database files should take precedence)"
                git reset --hard HEAD
                git pull origin main --no-rebase || true
                git add data/products.db data/exchange_rate.db
                git commit -m "Update product data and exchange rate [skip ci]" || true
              }
            }
          fi
          # Push 變更
          if [ -n "$(git log origin/main..HEAD)" ]; then
            git push origin main
          else
            echo "No changes to push"
          fi

  # 並行處理每個 URL
  track:
    needs: [prepare, update-exchange-rate]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # 一個失敗不影響其他
      max-parallel: 3 # 最多同時執行 3 個 job（可調整）
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    # 不再需要 contents: write，因為不再直接 commit
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright
        run: |
          playwright install chromium
          # Ubuntu 24.04 使用 libasound2t64 取代 libasound2
          # 手動安裝所有 Playwright 需要的依賴（playwright install-deps 在 Ubuntu 24.04 上可能失敗）
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libnspr4 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libatspi2.0-0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libasound2t64 \
            || true

      - name: Staggered delay (避免同時啟動)
        run: |
          # 根據 url_index 延遲啟動，每個 job 間隔 30 秒
          DELAY=$(( ${{ matrix.url_index }} * 30 ))
          echo "Waiting ${DELAY} seconds before starting..."
          sleep ${DELAY}

      - name: Run tracker for ${{ matrix.url_name }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          URL_INDEX: ${{ matrix.url_index }}
        run: |
          python main_single.py

      - name: Upload products database as artifact
        uses: actions/upload-artifact@v4
        with:
          name: products-db-${{ matrix.url_index }}
          path: data/products.db
          retention-days: 1

  # 通知 workflow 失敗
  notify-on-failure:
    needs: [test, update-exchange-rate, track, finalize]
    runs-on: ubuntu-latest
    if: always() && (needs.test.result == 'failure' || needs.update-exchange-rate.result == 'failure' || needs.track.result == 'failure' || needs.finalize.result == 'failure')
    steps:
      - name: Determine failed jobs
        id: failed-jobs
        run: |
          FAILED_JOBS=""
          if [ "${{ needs.test.result }}" == "failure" ]; then
            FAILED_JOBS="${FAILED_JOBS}• 測試失敗%0A"
          fi
          if [ "${{ needs.update-exchange-rate.result }}" == "failure" ]; then
            FAILED_JOBS="${FAILED_JOBS}• 更新匯率失敗%0A"
          fi
          if [ "${{ needs.track.result }}" == "failure" ]; then
            FAILED_JOBS="${FAILED_JOBS}• 商品追蹤失敗%0A"
          fi
          if [ "${{ needs.finalize.result }}" == "failure" ]; then
            FAILED_JOBS="${FAILED_JOBS}• 資料合併/提交失敗%0A"
          fi
          echo "failed_jobs=${FAILED_JOBS}" >> $GITHUB_OUTPUT

      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          FAILED_JOBS="${{ steps.failed-jobs.outputs.failed_jobs }}"
          
          MESSAGE="❌ <b>Workflow 執行失敗</b>%0A%0A"
          MESSAGE="${MESSAGE}Repository: ${{ github.repository }}%0A"
          MESSAGE="${MESSAGE}Workflow: ${{ github.workflow }}%0A"
          MESSAGE="${MESSAGE}Run ID: ${{ github.run_id }}%0A"
          MESSAGE="${MESSAGE}Commit: ${{ github.sha }}%0A"
          MESSAGE="${MESSAGE}觸發方式: ${{ github.event_name }}%0A%0A"
          MESSAGE="${MESSAGE}<b>失敗的 Job：</b>%0A${FAILED_JOBS}%0A"
          MESSAGE="${MESSAGE}<a href=\"${WORKFLOW_URL}\">查看詳細資訊</a>"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=HTML" \
            -d "disable_web_page_preview=false" || echo "Failed to send notification"
